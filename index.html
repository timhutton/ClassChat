<!DOCTYPE html>
<html>
<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<title>Class Chat!</title>
<link rel="icon" href="icon.png">
 
<script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.1.0/firebase-database.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyA2F8Dx3vrsLeFhS2E4fuILF5KmQKgWzWg",
    authDomain: "classchat-becd1.firebaseapp.com",
    databaseURL: "https://classchat-becd1.firebaseio.com",
    projectId: "classchat-becd1",
    storageBucket: "classchat-becd1.appspot.com",
    messagingSenderId: "533251351200"
  };
  firebase.initializeApp(config);
</script>

<script type="text/javascript">

firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    document.getElementById('logged_in').style.display="block";
    document.getElementById('login').style.display="none";
    on_login(user);
  } else {
    document.getElementById('logged_in').style.display="none";
    document.getElementById('login').style.display="block";
  }
});

function login(un,pw) {
    var email = un+'@sq3.org.uk'; // firebase requires email address as username, so we make a dummy one
    firebase.auth().signInWithEmailAndPassword(email, pw).catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      alert('Failed to login: '+errorMessage+'\n('+errorCode+')');
    });
}

function on_login(user) {
    // display their username
    document.getElementById("username").innerHTML = user.email.substring(0, user.email.lastIndexOf("@"));
    // make a live connection to the group chat messages
    document.getElementById("group_chat").innerHTML = "";
    var groupChatRef = firebase.database().ref('group_chat/messages');
    groupChatRef.on('child_added', function(data) {
      updateGroupChat(data.val());
    });
}

function logout() {
    firebase.auth().signOut().then(function() {
      // Sign-out successful.
    }).catch(function(error) {
      // An error happened.
      var errorCode = error.code;
      var errorMessage = error.message;
      alert('Failed to logout: '+errorMessage+'\n('+errorCode+')');
    });
}

function get_current_username() {
    var user = firebase.auth().currentUser;
    return user.email.substring(0, user.email.lastIndexOf("@"));
}

function get_pretty_time(t) {
    var now = Date.now();
    var sec = (now-t)/1000;
    if( sec < 60 ) { return sec.toFixed(0) + 's ago'; }
    var min = sec / 60;
    if( min < 60 ) { return min.toFixed(0) + 'min ago'; }
    var hour = min / 60;
    if( hour < 48 ) { return hour.toFixed(0) + 'hr ago'; }
    var day = hour / 24;
    if( day < 365*2 ) { return day.toFixed(0) + 'days ago'; }
    var year = day / 365;
    return year.toFixed(0) + 'years ago';
}

function sendGroupMessage(msg) {
    var message = {
        user: get_current_username(),
        time: Date.now(),
        text: msg
    };
    var groupChatRef = firebase.database().ref('group_chat/messages');
    var newGroupMessageRef = groupChatRef.push();
    newGroupMessageRef.set(message);
    document.getElementById("msg").value = ""; // clear the input box
}

function updateGroupChat(msg) {
    var box = document.getElementById("group_chat");
    box.innerHTML += msg.user + ' : ' + msg.text + ' (' + get_pretty_time(msg.time) + ')<br>';
    box.scrollTop = box.scrollHeight; // scroll to the bottom
}

</script>

<style>
body {
    background-color: powderblue;
    font-size: xx-large;
}
.username {color: blue;}
.group_chat {
    border: 1px solid black;
    padding: 30px;
    margin: 5px;
    height: 300px;
    overflow: auto;
}
</style>

</head>
<body>

Hello World!

<div id="login"> <!-- They see this if they are not logged-in -->

  <form action="javascript:login(un.value, pw.value)">
    Username: <input type="text" id="un"><br>
    Password: <input type="password" id="pw"><br>
    <input type="submit" value="Submit">
  </form> 

</div>

<div id="logged_in" style="display: none;">  <!-- They only see this if they are logged-in -->

  <p>Username: <span class="username" id="username">blank</span> <input type="button" value="sign out" onclick="logout();"></p>
  <div class="group_chat" id="group_chat"></div>
  <form action="javascript:sendGroupMessage(msg.value)">
    Message: <input type="text" id="msg"> <input type="submit" value="send">
  </form> 

</div>

</body>
</html>